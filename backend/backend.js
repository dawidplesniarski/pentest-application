const express = require('express')
const lighthouse = require('lighthouse')
const chromeLauncher = require('chrome-launcher')
const cors = require('cors')

const app = express()
const port = 5000

app.use(cors())

app.get('/performance', async (req, res) => {
  let url = req.query.url

  if (!url) {
    res.status(400)
    res.send('Please provide url')
  } else {
    console.log('checking for', url)

    const chrome = await chromeLauncher.launch({ chromeFlags: ['--headless'] })
    const options = {
      logLevel: 'info',
      output: 'html',
      onlyCategories: ['performance'],
      port: chrome.port,
    }
    const runnerResult = await lighthouse(url, options)

    console.log('result', runnerResult)

    res.send('Hello World!')
  }
})

app.listen(port, () => {
  console.log(`Example app listening at http://localhost:${port}`)
})
